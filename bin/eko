#!/usr/bin/env ruby
$: << File.join(File.dirname(__FILE__), '../lib')
require 'eko'
require 'optparse'


def parse_options
  
  options = { :format => :text }

  OptionParser.new do |opts|
    opts.banner = "Usage: #{$0} [options]"

    opts.separator ""
    opts.separator "Specific options:"

    opts.on("-m", "--min_tempo BPM", Integer, "Specify minimum tempo") do |bpm|
      options[:min_tempo] = bpm
    end

    opts.on("-M", "--max_tempo BPM", Integer, "Specify maximum tempo") do |bpm|
      options[:max_tempo] = bpm
    end

    opts.on("-t", "--time_sig TS", Integer, "Specify time signature") do |ts|
      options[:time_signature] = ts
    end
    
    opts.on("-d", "--mode MODE", String, "Specify mode (minor or major)") do |mode|
      unless Eko::Song::MODES.include?(mode)
        raise ArgumentError.new("Mode must be #{Eko::Song::MODES.join(' or ')}") 
      end
      options[:mode] = mode
    end

    # # List of arguments.
    # opts.on("--list x,y,z", Array, "Example 'list' of arguments") do |list|
    #   options.list = list
    # end


    opts.on("-f", "--format [FORMAT]", Eko::Playlist::FORMATS,
            "Select output type (#{Eko::Playlist::FORMATS.join(', ')})") do |format|
      unless Eko::Playlist::FORMATS.include?(format)
        raise ArgumentError.new("Format must be one of #{Eko::Playlist::FORMATS.join(', ')}") 
      end
      options[:format] = format
    end


    opts.separator ""
    opts.separator "Common options:"

    # No argument, shows at tail.  This will print an options summary.
    # Try it and see!
    opts.on_tail("-h", "--help", "Show this message") do
      puts opts
      exit
    end

    # Another typical switch to print the version.
    # opts.on_tail("--version", "Show version") do
    #   puts OptionParser::Version.join('.')
    #   exit
    # end
  end.parse!

  options
end


case ARGV[0]
when 'scan'
  ARGV.shift
  ARGV.each do |file|
    Eko::Song.create_from_file!(file)
  end
when 'playlist'
  options = parse_options
  format = options.delete(:format)
  playlist = Eko::Playlist.create_from_options(options)
  puts playlist.inspect
  puts playlist.output(format)
else
  puts "nothing for #{ARGV[0]}"
end


#$: droptheboom --min-tempo=130 --max-tempo=150 --mode=minor --output=cool_playlist.pls
# opts = ParseOpts.blahblah
# filtered_songs = Eko.songs(opts)
# Eko.create_playlist(filtered_songs)


